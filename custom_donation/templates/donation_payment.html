<!DOCTYPE html>
<html>
  <head>
    <title>Donation Payment</title>
    <script src="https://js.stripe.com/v3/"></script>
  </head>
  <body>
    <form id="payment-form" action="/donation/process_payment" method="POST">
      <input type="hidden" name="donation_id" value="{{ donation_id }}" />

      <div>
        <label for="card-element"> Credit or debit card </label>
        <div id="card-element"></div>
        <div id="card-errors" role="alert"></div>
      </div>

      <button type="submit">Pay</button>
    </form>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var stripe = Stripe("{{ publishable_key }}");
        var elements = stripe.elements();

        var cardElement = elements.create("card");
        cardElement.mount("#card-element");

        cardElement.on("change", function (event) {
          var displayError = document.getElementById("card-errors");
          if (event.error) {
            displayError.textContent = event.error.message;
          } else {
            displayError.textContent = "";
          }
        });

        var form = document.getElementById("payment-form");
        form.addEventListener("submit", function (event) {
          event.preventDefault();

          stripe
            .createPaymentMethod("card", cardElement)
            .then(function (result) {
              if (result.error) {
                var errorElement = document.getElementById("card-errors");
                errorElement.textContent = result.error.message;
              } else {
                var paymentIntentIdElement = document.createElement("input");
                paymentIntentIdElement.setAttribute("type", "hidden");
                paymentIntentIdElement.setAttribute(
                  "name",
                  "payment_intent_id"
                );
                paymentIntentIdElement.setAttribute(
                  "value",
                  result.paymentMethod.id
                );
                form.appendChild(paymentIntentIdElement);

                form.submit();
              }
            });
        });
      });
    </script>
  </body>
</html>
